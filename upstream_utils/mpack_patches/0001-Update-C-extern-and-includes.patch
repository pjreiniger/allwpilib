From bd1b118d2f021918c1eb11bde9ec4dcc6cdd0023 Mon Sep 17 00:00:00 2001
From: PJ Reiniger <pj.reiniger@gmail.com>
Date: Fri, 21 Oct 2022 20:40:15 -0400
Subject: [PATCH] Update C++ extern and includes

---
 src/mpack/mpack-node.c     | 1 +
 src/mpack/mpack-platform.c | 3 ++-
 src/mpack/mpack-platform.h | 2 +-
 src/mpack/mpack-writer.h   | 3 ++-
 tools/amalgamate.sh        | 4 ++--
 5 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/src/mpack/mpack-node.c b/src/mpack/mpack-node.c
index 3d4b0f4..0919183 100644
--- a/src/mpack/mpack-node.c
+++ b/src/mpack/mpack-node.c
@@ -2401,4 +2401,5 @@ mpack_node_t mpack_node_map_value_at(mpack_node_t node, size_t index) {
 
 #endif
 
+}  // namespace wpi
 MPACK_SILENCE_WARNINGS_END
diff --git a/src/mpack/mpack-platform.c b/src/mpack/mpack-platform.c
index 6599e1f..21786bd 100644
--- a/src/mpack/mpack-platform.c
+++ b/src/mpack/mpack-platform.c
@@ -24,12 +24,13 @@
 // standalone definitions of all (non-static) inline functions in MPack.
 
 #define MPACK_INTERNAL 1
-#define MPACK_EMIT_INLINE_DEFS 1
+#define MPACK_EMIT_INLINE_DEFS 0
 
 #include "mpack-platform.h"
 #include "mpack.h"
 
 MPACK_SILENCE_WARNINGS_BEGIN
+namespace mpack {
 
 #if MPACK_DEBUG
 
diff --git a/src/mpack/mpack-platform.h b/src/mpack/mpack-platform.h
index 79604c9..27a2f9e 100644
--- a/src/mpack/mpack-platform.h
+++ b/src/mpack/mpack-platform.h
@@ -1043,7 +1043,7 @@ void mpack_assert_fail(const char* message);
  */
 
 #ifdef __cplusplus
-    #define MPACK_EXTERN_C_BEGIN extern "C" {
+    #define MPACK_EXTERN_C_BEGIN namespace mpack {
     #define MPACK_EXTERN_C_END   }
 #else
     #define MPACK_EXTERN_C_BEGIN /*nothing*/
diff --git a/src/mpack/mpack-writer.h b/src/mpack/mpack-writer.h
index c239ee6..abeee1a 100644
--- a/src/mpack/mpack-writer.h
+++ b/src/mpack/mpack-writer.h
@@ -1168,6 +1168,7 @@ MPACK_EXTERN_C_END
 
 #if defined(__cplusplus) || defined(MPACK_DOXYGEN)
 
+namespace mpack {
 /**
  * @name C++ write overloads
  * @{
@@ -1304,7 +1305,7 @@ MPACK_INLINE void mpack_write_kv(mpack_writer_t* writer, const char *key, const
 /**
  * @}
  */
-
+}  // namespace mpack
 #endif /* __cplusplus */
 
 /**
diff --git a/tools/amalgamate.sh b/tools/amalgamate.sh
index 2e24e27..4dfe999 100755
--- a/tools/amalgamate.sh
+++ b/tools/amalgamate.sh
@@ -74,8 +74,8 @@ echo -e "#endif\n" >> $HEADER
 
 # assemble source
 echo -e "#define MPACK_INTERNAL 1" >> $SOURCE
-echo -e "#define MPACK_EMIT_INLINE_DEFS 1\n" >> $SOURCE
-echo -e "#include \"mpack.h\"\n" >> $SOURCE
+echo -e "#define MPACK_EMIT_INLINE_DEFS 0\n" >> $SOURCE
+echo -e "#include \"wpi/mpack.h\"\n" >> $SOURCE
 for f in $SOURCES; do
     echo -e "\n/* $f.c */" >> $SOURCE
     sed -e 's@^#include ".*@/* & */@' -e '0,/^ \*\/$/d' src/$f >> $SOURCE
